-- === Database & Schema ===
CREATE DATABASE IF NOT EXISTS poos_db
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;
USE poos_db;

-- === Users (login/register owner of contacts) ===
CREATE TABLE IF NOT EXISTS users (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  email    VARCHAR(100) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL, -- store bcrypt/argon hashes, not plaintext
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- === Contacts (belong to a user) ===
CREATE TABLE IF NOT EXISTS contacts (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  first_name VARCHAR(100) NOT NULL,
  last_name  VARCHAR(100) NOT NULL,
  email      VARCHAR(150),
  phone      VARCHAR(20),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  CONSTRAINT fk_contacts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_contacts_user_name (user_id, last_name, first_name),
  INDEX idx_contacts_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Optional: prevent duplicate contact emails per owner (allows NULL emails):
CREATE UNIQUE INDEX uq_contacts_per_user_email
  ON contacts(user_id, email);

-- === Optional Tagging (nice-to-have; can skip if not needed now) ===
CREATE TABLE IF NOT EXISTS tags (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL UNIQUE,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS contact_tags (
  contact_id BIGINT UNSIGNED NOT NULL,
  tag_id     BIGINT UNSIGNED NOT NULL,
  PRIMARY KEY (contact_id, tag_id),
  CONSTRAINT fk_ct_contact FOREIGN KEY (contact_id) REFERENCES contacts(id) ON DELETE CASCADE,
  CONSTRAINT fk_ct_tag FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- === Seed data for quick testing (optional) ===
INSERT INTO users (username, email, password_hash) VALUES
('alice','alice@example.com','$2y$10$exampleexampleexampleexampleexampleexampleexampleexample'),
('bob','bob@example.com','$2y$10$exampleexampleexampleexampleexampleexampleexampleexample')
ON DUPLICATE KEY UPDATE email=VALUES(email);

INSERT INTO contacts (user_id, first_name, last_name, email, phone) VALUES
(1, 'Ada',  'Lovelace', 'ada@uni.edu',  '+1-555-0101'),
(1, 'Alan', 'Turing',   'alan@uni.edu', '+1-555-0102')
ON DUPLICATE KEY UPDATE email=VALUES(email);
